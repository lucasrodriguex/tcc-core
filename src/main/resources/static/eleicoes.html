<!DOCTYPE html>
<html>
<head>
	<title>Projeto final - Mapa</title>
</head>
<body>

<style type="text/css">
	
div.tooltip {	
    position: absolute;			
    text-align: center;			
    width: auto;
    height: auto;					
    padding: 4px 10px;				
    font: 16px Helvetica, Arial, sans-serif;
    font-weight: lighter;
    background: #FFF;	
    border: 0px;		
    border-radius: 2px;			
    pointer-events: none;
    white-space: nowrap;		
}

div h1 {	
    position: absolute;			
    text-align: center;			
    width: auto;
    height: auto;					
    padding: 4px 10px;				
    font: 36px Helvetica, Arial, sans-serif;
    font-weight: lighter;
    background: #FFF;	
    border: 0px;		
    border-radius: 2px;			
    pointer-events: none;
    white-space: nowrap;
    opacity: .9;	
}

.legend {
	font-size: 12px;
}
rect {
	stroke-width: 2;
}

</style>

<div id = "map" style="background-color:#F2F2F6; width:800px;height:400px">
<h1>Selecione um estado:</h1>

</div>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>

<script type="text/javascript">

var width = 800,
    height = 400
    
//var width = window.innerWidth, height = window.innerHeight;
var projection = d3.geoEquirectangular().scale(width / (2*Math.PI) )
var path = d3.geoPath().projection(projection);
var color = ["black","gray","red","blue","orange","green", "white", "gray", "black"];
//d3.scaleOrdinal()	
//  .range(["#FF0000", "#009933" , "#333333"]);
  
//var color = d3.schemeCategory20c;

var scale = d3.scaleLinear();
scale.domain ([0,7000000000]);
scale.range([8,100000]);

var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height + 100);


var div = d3.select("body").append("div")	
    .attr("class", "tooltip")				
    .style("opacity", 0);

var selected = "";

d3.json("eleicoes2014turno2.json", function(error, mapa) {
	render(error,mapa)
});

var zoomscale = 400;

var lastKnownPos = window.scrollY();

function render(error,mapa) {
		if (error) throw error;

		mapa.forEach(function(d) {
		    d.cx = projection([d.longitude,d.latitude])[0];
	        d.cy = projection([d.longitude,d.latitude])[1];
	
	        d.x = d.cx;
	        d.y = d.cy;
			
			if(d.eleitorado != null) {
                d.radius = Math.sqrt(d.eleitorado/Math.PI)/zoomscale;
                if (d.radius < 1) d.radius = 1;
			} else {
				d.radius =  1;
			}
		});
					
		var pies = svg.selectAll(".pie")
			.data(mapa)
			.enter()
			.append('g')
			.attr('class','pie')
			.style("cursor", "pointer");
			
		pies.each(function(d,i){
			var pieG = d3.select(this).attr("cx", d.cx).attr("cy", d.cy);

			var arc = d3.arc()
						.outerRadius(d.radius)
						.innerRadius(0);
			
			var pie = d3.pie()
						.sort(null)
						.value(function(d) { return d; });

			var data;
			if(d.eleitorado == null) {
				data = [1,0,0,0,0,0,0,0,0,0];
			} else {
				data = [0, d.Dilma, d.Aecio, d.Marina, d.zoutros, d.zbranco, d.znulo, d.zabstencao ]; 
			}

			var g = pieG.selectAll(".arc")
			.data(pie(data))
			.enter().append("g")
			.attr("class", "arc")
			//.attr("transform", function(d) {return "translate(" + d.x + ", " + d.y  + ")";})
			//.attr("cx", function(d) { return d.cx; }).attr("cy", function(d) { return d.cy; })
			
			g.append("path")
				.attr('d',arc)
				.attr("fill",function(d,i){
					return color[i+1];     
				});
		});
		var simulation = d3.forceSimulation()
				.force('x', d3.forceX().x( function(d) { return d.cx} ))
				.force('y', d3.forceY().y( function(d) { return d.cy} ))
				.force("collide", d3.forceCollide().strength(1).radius(function(d){return d.radius + 0.5; }).iterations(2))
				.on("tick", function(d){
					pies.attr("transform", function(d) {return "translate(" + d.x + ", " + d.y  + ")";});
					
                    pies.attr("cx", function(d) { return d.cx; }).attr("cy", function(d) { return d.cy; });
				
				})
                .nodes(mapa)
        
        pies.on("mouseover", function(d) {		
            div.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div.html("<span>"+d.commonName+"</span>")	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");
        })					
        .on("mouseout", function(d) {		
            div.transition()		
	            .duration(500)		
	            .style("opacity", 0);
        })
        .on("click", function(d) {
            if(selected!=this){
            	selected = this;
				d3.select(this.parentNode).selectAll(".pie").style("opacity", .2);
		        d3.select(this)
		        	.style("opacity", 1);
	            }
	         else {
	         	selected = "";
				d3.select(this.parentNode).selectAll(".pie").style("opacity", 1);
	         	}
        });
			
}


var root = svg;

function lapsedZoomFit(ticks, transitionDuration) {
    for (var i = ticks || 100; i > 0; --i) force.tick();
    force.stop();
    zoomFit(transitionDuration);
}

function zoomFit(transitionDuration) {
    var bounds = root.node().getBBox();
    var parent = root.node().parentElement;
    var fullWidth = parent.clientWidth || parent.parentNode.clientWidth,
        fullHeight = parent.clientHeight || parent.parentNode.clientHeight;
    var width = bounds.width,
        height = bounds.height;
    var midX = bounds.x + width / 2,
        midY = bounds.y + height / 2;
    if (width == 0 || height == 0) return; // nothing to fit
    var scale = 0.85 / Math.max(width / fullWidth, height / fullHeight);
    var translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];

    console.trace("zoomFit", translate, scale);

    root
        .transition()
        .duration(transitionDuration || 0) // milliseconds
        .call(zoom.translate(translate).scale(scale).event);
}
</script>
<script src="mapa2d.js"></script>

</body>
</html>